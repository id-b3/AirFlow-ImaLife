FROM ubuntu:trusty AS builder

# Prepare building tools and libraries
RUN apt-get update && apt-get install -y cmake wget build-essential uuid-dev libgmp-dev libmpfr-dev libnifti-dev libx11-dev libboost-all-dev
RUN apt-get install -y --no-install-recommends libgts-dev libsdl2-dev libsdl2-2.0 libcgal-dev libgsl0-dev

# OPFRONT
# -----------------------------------------
WORKDIR /opfront
COPY ./opfront .
RUN mv /opfront/thirdparty/CImg.h /usr/include/CImg.h
RUN mkdir /opfront/bin && cd /opfront/bin && cmake /opfront/src && make -j16 install

# PLAYGROUND
# -----------------------------------------
WORKDIR /lungseg

# 2. ITK - PATCHED VERSION - Pre-compiler mod.
COPY ./playground/thirdparty/InsightToolkit-3.20.1 ./InsightToolkit-3.20.1
RUN mkdir itkbin && cd itkbin && cmake -DBUILD_EXAMPLES:BOOL=OFF -DBUILD_TESTING:BOOL=OFF -DBUILD_SHARED_LIBS:BOOL=ON ../InsightToolkit-3.20.1/ && make -j install

# -----------------------------------------
# SOURCECODE
COPY ["./legacy/", "./legacy/"]
COPY ["./playground/", "./playground/"]

RUN make -C /lungseg/playground/thirdparty/kdtree install

# Compile the tools
RUN make -C /lungseg/playground/src/libac && \
    make -C /lungseg/playground/src/libmy_functions && \
    make -C /lungseg/playground/src/lung_segmentation && \
    make -C /lungseg/playground/src/6con && \
    make -C /lungseg/playground/src/be && \
    make -C /lungseg/playground/src/scale_branch && \
    make -C /lungseg/playground/src/gts_ray_measure && \
    make -C /lungseg/playground/src/connected_brh && \
    make -C /lungseg/playground/src/smooth_brh && \
    make -C /lungseg/playground/src/brh_translator && \
    make -C /lungseg/playground/src/imgconv
# RUN make -C /lungseg/playground/src/tcgc_phantom_trainer && \

# Copy the tools
RUN mkdir /lungseg/bins && \
    cp /lungseg/playground/src/lung_segmentation/lung_segmentation /lungseg/bins && \
    cp /lungseg/playground/src/6con/6con /lungseg/bins && \
    cp /lungseg/playground/src/be/be /lungseg/bins && \
    cp /lungseg/playground/src/scale_branch/scale_branch /lungseg/bins && \
    cp /lungseg/playground/src/gts_ray_measure/gts_ray_measure /lungseg/bins && \
    cp /lungseg/playground/src/connected_brh/connected_brh /lungseg/bins && \
    cp /lungseg/playground/src/smooth_brh/smooth_brh /lungseg/bins && \
    cp /lungseg/playground/src/imgconv/imgconv /lungseg/bins && \
    cp /lungseg/playground/src/brh_translator/brh_translator /lungseg/bins
# RUN cp /lungseg/playground/src/tcgc_phantom_trainer/tcgc_phantom_trainer /lungseg/bins && \

ENTRYPOINT ["/bin/bash"]
